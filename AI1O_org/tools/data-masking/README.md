# テキストマスキングツール

テキストファイル内の会社名と個人名を自動的にマスキングするCLIツールです。

## 機能

- 日本語の個人名と会社名を自動検出してマスキング
- ファイル内容だけでなく、ファイル名に含まれる個人名・会社名もマスキング
- spaCy (GiNZA) を使用した高精度な日本語固有表現認識
- **マルチプロセッシングによる高速並列処理**
- 処理完了後、ファイルを自動的に出力フォルダへ移動（ディレクトリ構造を維持）

## 必要環境

- Python 3.12以降
- pyenv (推奨) または Poetry

## インストール

### pyenvを使用する場合:

```bash
# Python 3.12.7をインストール
pyenv install 3.12.7
pyenv local 3.12.7

# 依存関係をインストール
pip install -r requirements.txt
```

### Poetryを使用する場合:

```bash
# Poetryをインストール（未インストールの場合）
curl -sSL https://install.python-poetry.org | python3 -

# 依存関係をインストール
poetry install

# 仮想環境を有効化
poetry shell
```

## 使用方法

### 初回セットアップ

GiNZAモデルのインストールが必要です。以下のいずれかの方法でインストールしてください:

#### 方法 1: インストールスクリプトを使用

```bash
python install_ginza.py
```

#### 方法 2: 手動インストール

```bash
pip install ginza ja-ginza ja-ginza-electra
```

基本的な使用方法:

```bash
python mask_text.py
```

オプション:

```bash
# 入力・出力ディレクトリを指定
python mask_text.py -i input_folder -o output_folder

# 複数の拡張子を処理
python mask_text.py -e .txt -e .log -e .csv
```

### オプション一覧

- `-i, --input-dir`: マスキング前のファイルがあるディレクトリ（デフォルト: `before`）
- `-o, --output-dir`: マスキング後のファイルを保存するディレクトリ（デフォルト: `after`）
- `-e, --extensions`: 処理対象のファイル拡張子（デフォルト: `.txt`）
- `-w, --workers`: 並列処理のワーカー数（デフォルト: CPUコア数）

## 例

```bash
# beforeフォルダ内の.txtファイルをマスキング（デフォルト設定）
python mask_text.py

# カスタムフォルダを使用
python mask_text.py -i raw_data -o masked_data

# 複数の拡張子を処理
python mask_text.py -e .txt -e .log

# ワーカー数を指定して並列処理（8つのプロセスで処理）
python mask_text.py -w 8

# すべてのオプションを組み合わせて使用
python mask_text.py -i input_data -o output_data -e .txt -e .log -e .csv -w 4
```

## 注意事項

- 初回実行時はGiNZAモデルのインストールが必要です（`install_ginza.py`を実行）
- spaCy + GiNZAを使用して日本語の固有表現認識を行います
- 処理後のファイルは元のファイルから自動的に削除されます
- GiNZAモデルはサイズが大きいため、初回インストールに時間がかかる場合があります
- 大きなファイル（40KB以上）は自動的にチャンクに分割して処理されます
- 並列処理により高速化されていますが、大量のファイル処理時はメモリ使用量に注意してください
- ワーカー数を増やしすぎるとメモリ不足になる可能性があります

## マスキング例

### ファイル内容のマスキング

入力:
```
山田太郎さんは、株式会社サイバーエージェントで働いています。
```

出力:
```
[個人名]さんは、[会社名]で働いています。
```

### ファイル名のマスキング

入力ファイル名:
```
山田太郎_ソフトバンク契約書.txt
```

出力ファイル名:
```
[個人名]_[会社名]契約書.txt
```

### ディレクトリ構造の保持

元のディレクトリ構造:
```
before/
├── 山田太郎/
│   ├── 田中花子_契約書.txt
│   └── ソフトバンク関連/
│       └── NTTドコモ比較資料.txt
└── sample1.txt
```

マスキング後のディレクトリ構造:
```
after/
├── 山田太郎/  ※ ディレクトリ名はマスキングされません
│   ├── [個人名]_契約書.txt
│   └── ソフトバンク関連/
│       └── [会社名]比較資料.txt
└── sample1.txt
```

## パフォーマンス

### 並列処理による高速化

本ツールはマルチプロセッシングに対応しており、複数のファイルを並列で処理できます：

- **デフォルト**: システムのCPUコア数に応じて自動的にワーカー数を設定
- **カスタム設定**: `-w`オプションでワーカー数を指定可能
- **推奨設定**: 
  - 小〜中規模（〜1000ファイル）: CPUコア数と同じ
  - 大規模（1000ファイル以上）: CPUコア数の半分程度

例: 8コアCPUで1000個のファイルを処理する場合、並列処理により処理時間を約1/8に短縮可能です。